<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | 24*7 Health</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (Inline SVGs used for reliability) -->
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .nav-active { background-color: rgb(37, 99, 235); color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .card-anim { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-item { transition: all 0.2s ease; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="lg:hidden fixed bottom-6 right-6 z-50 bg-blue-600 text-white p-4 rounded-full shadow-2xl">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-slate-900 text-slate-300 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0 transition-transform duration-300 ease-in-out">
            <div class="p-6">
                <h2 class="text-white text-xl font-bold flex items-center gap-2">
                    <span class="bg-blue-600 p-1.5 rounded-lg">HH</span>
                    24*7 Health Admin
                </h2>
            </div>
            
            <nav class="mt-4 px-4 space-y-2">
                <button onclick="switchTab('opinions')" id="tab-opinions" class="sidebar-item flex items-center gap-3 w-full p-3 rounded-lg hover:bg-slate-800 hover:text-white group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-blue-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    Blogs & Opinions
                </button>
                
                <button onclick="switchTab('ambulance')" id="tab-ambulance" class="sidebar-item flex items-center gap-3 w-full p-3 rounded-lg hover:bg-slate-800 hover:text-white group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-blue-400"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                    Ambulance Partners
                </button>

                <div class="pt-10">
                    <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">System</p>
                    <button id="logoutBtn"
                        class="mt-2 sidebar-item flex items-center gap-3 w-full p-3 rounded-lg hover:bg-red-900/20 hover:text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Logout
                    </button>

                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-4 lg:p-10">
            <!-- Header Section -->
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h1 id="viewTitle" class="text-3xl font-bold text-slate-800">Blogs & Opinions</h1>
                    <p id="viewSubtitle" class="text-slate-500">Respond to user feedback and publish insights.</p>
                </div>
                <div class="hidden md:block">
                    <span class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-medium">Administrator Access</span>
                </div>
            </div>

            <!-- Opinions View -->
            <section id="view-opinions" class="view-content space-y-6">
                <div id="pendingOpinionsContainer" class="grid gap-6">
                    <div class="animate-pulse bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                        <div class="h-4 bg-slate-200 rounded w-1/4 mb-4"></div>
                        <div class="h-6 bg-slate-200 rounded w-3/4"></div>
                    </div>
                </div>
            </section>

            <!-- Ambulance View -->
            <section id="view-ambulance" class="view-content hidden space-y-6">
                <div id="providersContainer" class="grid gap-4">
                    <!-- Providers will be rendered here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE_URL = '/api';
        let currentTab = 'opinions';

        // --- Tab Management ---
        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('bg-blue-600', 'text-white'));
            
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('bg-blue-600', 'text-white');

            const titles = {
                'opinions': ['Blogs & Opinions', 'Respond to user feedback and publish insights.'],
                'ambulance': ['Ambulance Approvals', 'Manage and vet healthcare partner applications.']
            };

            document.getElementById('viewTitle').textContent = titles[tabId][0];
            document.getElementById('viewSubtitle').textContent = titles[tabId][1];

            // Load data for specific tab
            if (tabId === 'opinions') fetchPendingOpinions();
            if (tabId === 'ambulance') loadProviders();

            // Close sidebar on mobile after selection
            if(window.innerWidth < 1024) toggleSidebar();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);

        // --- Opinions Logic ---
        async function fetchPendingOpinions() {
            const container = document.getElementById('pendingOpinionsContainer');
            try {
                const response = await fetch(`${API_BASE_URL}/opinions/pending`);
                const data = await response.json();
                renderOpinions(data.opinions);
            } catch (error) {
                container.innerHTML = `<div class="bg-red-50 text-red-600 p-6 rounded-xl border border-red-100">Failed to load opinions. Please check server connection.</div>`;
            }
        }

        function renderOpinions(opinions) {
            const container = document.getElementById('pendingOpinionsContainer');
            if (!opinions || opinions.length === 0) {
                container.innerHTML = `
                    <div class="bg-white p-12 text-center rounded-2xl shadow-sm border border-slate-200">
                        <div class="bg-green-100 text-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">✓</div>
                        <h3 class="text-lg font-bold">No Pending Opinions</h3>
                        <p class="text-slate-500">Your inbox is completely clear.</p>
                    </div>`;
                return;
            }

            container.innerHTML = opinions.map(opinion => `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 card-anim hover:shadow-md" data-opinion-id="${opinion.id}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">${opinion.user_name}</h4>
                            <p class="text-sm text-blue-600">${opinion.user_email}</p>
                        </div>
                        <span class="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded">
                            ${new Date(opinion.created_at).toLocaleDateString()}
                        </span>
                    </div>
                    <p class="text-slate-700 bg-slate-50 p-4 rounded-lg italic mb-6 border-l-4 border-blue-500">"${opinion.opinion_text}"</p>
                    
                    <form class="space-y-4" onsubmit="event.preventDefault(); handleOpinionSubmit(this, '${opinion.id}')">
                        <textarea class="w-full p-4 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" 
                            rows="3" placeholder="Write your professional response..." required></textarea>
                        <button type="submit" class="w-full md:w-auto bg-slate-900 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                            Submit & Publish Response
                        </button>
                    </form>
                </div>
            `).join('');
        }

        async function handleOpinionSubmit(form, id) {
            const btn = form.querySelector('button');
            const answerText = form.querySelector('textarea').value;
            btn.disabled = true;
            btn.textContent = 'Publishing...';

            try {
                const response = await fetch(`${API_BASE_URL}/opinions/${id}/answer`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer_text: answerText })
                });

                if (response.ok) {
                    const card = document.querySelector(`[data-opinion-id="${id}"]`);
                    card.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => fetchPendingOpinions(), 300);
                }
            } catch (e) {
                alert('Error submitting answer');
                btn.disabled = false;
                btn.textContent = 'Submit & Publish Response';
            }
        }

        // --- Ambulance Provider Logic ---
        async function loadProviders() {
            const container = document.getElementById('providersContainer');
            try {
                const res = await fetch(`${API_BASE_URL}/admin/providers`);
                const data = await res.json();

                if (!data.providers || data.providers.length === 0) {
                    container.innerHTML = `<div class="p-10 text-center text-slate-400">No providers found.</div>`;
                    return;
                }

                container.innerHTML = data.providers.map(p => `
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-4 card-anim">
                        <div class="flex gap-4 items-center">
                            <div class="bg-blue-50 text-blue-600 p-3 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            </div>
                            <div>
                                <h2 class="font-bold text-slate-800">${p.provider_name}</h2>
                                <p class="text-xs text-slate-500 uppercase tracking-tighter">${p.provider_type} • ${p.city}, ${p.state}</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <span class="block text-[10px] font-bold text-slate-400 uppercase">Status</span>
                                <span class="px-2 py-0.5 rounded-full text-xs font-bold ${
                                    p.status === 'Pending' ? 'bg-amber-100 text-amber-700' : 
                                    p.status === 'Approved' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                                }">${p.status}</span>
                            </div>

                            <div class="flex gap-2 border-l pl-4 border-slate-100">
                                ${p.status === 'Pending' ? `
                                    <button onclick="approveProvider('${p.provider_uid}')" class="bg-emerald-500 text-white p-2 rounded-lg hover:bg-emerald-600 transition-colors shadow-sm" title="Approve">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    </button>
                                    <button onclick="rejectProvider('${p.provider_uid}')" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors shadow-sm" title="Reject">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>
                                ` : `
                                    <span class="text-slate-300 italic text-xs">No Actions</span>
                                `}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = `<p class="text-red-500">Error loading partners.</p>`;
            }
        }

        async function approveProvider(uid) {
            if(!confirm('Approve this partner?')) return;
            await fetch(`${API_BASE_URL}/providers/approve/${uid}`, { method: 'PUT' });
            loadProviders();
        }

        async function rejectProvider(uid) {
            const reason = prompt("Reason for rejection?");
            if (reason === null) return;
            await fetch(`${API_BASE_URL}/providers/reject/${uid}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            loadProviders();
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('opinions');
        });
    </script>
    <script>
        document.getElementById("logoutBtn").addEventListener("click", () => {
            // Clear auth data
            localStorage.removeItem("token");
            localStorage.removeItem("user");

            // OR if using sessionStorage
            sessionStorage.clear();

            // Redirect
            window.location.replace("index.html");
        });
    </script>

</body>
</html>