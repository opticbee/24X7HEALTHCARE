<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - 24x7 Health Services</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background-color: #1a1a1a;
        }

        #localVideo {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 150px;
            height: 200px;
            border-radius: 12px;
            z-index: 2;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        #controls {
            position: fixed;
            bottom: 20px;
            z-index: 3;
            display: flex;
            gap: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 50px;
        }
        
        .control-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        #toggleAudioBtn { background-color: #28a745; }
        #toggleVideoBtn { background-color: #007bff; }
        #switchCameraBtn { background-color: #f0ad4e; }
        #leaveBtn { background-color: #dc3545; }

        .control-btn.off { background-color: #6c757d; }

        .status-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.2rem;
            z-index: 10;
        }

        /* Custom Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            max-width: 400px;
        }
        .modal-content p {
            margin: 0 0 20px;
            font-size: 18px;
            color: #333;
        }
        .modal-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <script>
        // --- Login Check ---
        (function() {
            const userIsLoggedIn = localStorage.getItem('patientUser') || sessionStorage.getItem('patientUser') || localStorage.getItem('doctorUid');
            
            if (!userIsLoggedIn) {
                const modalBackdrop = document.createElement('div');
                modalBackdrop.className = 'modal-backdrop';
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.innerHTML = `
                    <p>Please log in to join the video call.</p>
                    <button id="login-redirect-btn">Go to Login</button>
                `;

                modalBackdrop.appendChild(modalContent);
                document.body.appendChild(modalBackdrop);

                document.getElementById('login-redirect-btn').addEventListener('click', () => {
                    window.location.href = 'login.html';
                });

                throw new Error("User not logged in. Halting script execution.");
            }
        })();
    </script>

    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    
    <div id="controls">
        <button id="toggleAudioBtn" class="control-btn"><i class="fas fa-microphone"></i></button>
        <button id="toggleVideoBtn" class="control-btn"><i class="fas fa-video"></i></button>
        <button id="switchCameraBtn" class="control-btn"><i class="fas fa-camera-rotate"></i></button>
        <button id="leaveBtn" class="control-btn"><i class="fas fa-phone-slash"></i></button>
    </div>

    <div id="statusMessage" class="status-message" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const ROOM_ID = urlParams.get('roomId');
        
        if (!ROOM_ID) {
            document.body.innerHTML = '<div class="status-message">Error: Room ID is missing.</div>';
            throw new Error("No roomId provided in the URL.");
        }

        const socket = io("https://24x7healthcare.in", { transports: ["websocket", "polling"] });

        const ICE_SERVERS = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const leaveBtn = document.getElementById('leaveBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const statusMessage = document.getElementById('statusMessage');

        let localStream;
        let peerConnection;
        let isAudioMuted = false;
        let isVideoOff = false;
        let currentCameraId = null;

        const updateStatus = (message) => {
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
        };

        const createPeerConnection = (peerSocketId) => {
            const pc = new RTCPeerConnection(ICE_SERVERS);
            
            pc.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('signal', { to: peerSocketId, payload: { type: 'candidate', candidate: event.candidate } });
                }
            };
            
            pc.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
                updateStatus('Connected!');
            };

            return pc;
        };
        
        const init = async () => {
            updateStatus('Connecting...');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }, // Start with front camera by default
                    audio: true
                });
                localVideo.srcObject = localStream;
                currentCameraId = localStream.getVideoTracks()[0].getSettings().deviceId;
                socket.emit('join-room', ROOM_ID); 
            } catch (err) {
                console.error("Error accessing media devices.", err);
                let errorMessage;
                if (err.name === 'NotAllowedError') {
                    errorMessage = 'Please allow camera and microphone access.';
                } else if (err.name === 'NotFoundError') {
                    errorMessage = 'No camera or microphone found.';
                } else {
                    errorMessage = 'Device in Use. Please close other applications using your camera.';
                }
                updateStatus(errorMessage);
            }
        };
        
        const replaceVideoTrack = async () => {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length <= 1) {
                    updateStatus('No other camera found.');
                    setTimeout(() => updateStatus(''), 2000);
                    return;
                }

                const currentDeviceIndex = videoDevices.findIndex(d => d.deviceId === currentCameraId);
                const nextDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
                const nextDevice = videoDevices[nextDeviceIndex];

                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: nextDevice.deviceId } },
                    audio: true
                });
                
                const newVideoTrack = newStream.getVideoTracks()[0];
                const oldVideoTrack = localStream.getVideoTracks()[0];
                
                localStream.removeTrack(oldVideoTrack);
                localStream.addTrack(newVideoTrack);
                localVideo.srcObject = localStream;
                currentCameraId = nextDevice.deviceId;

                if (peerConnection) {
                    const videoSender = peerConnection.getSenders().find(sender => sender.track.kind === 'video');
                    if (videoSender) {
                        videoSender.replaceTrack(newVideoTrack);
                    }
                }
                oldVideoTrack.stop();

            } catch (err) {
                console.error("Error switching camera:", err);
                updateStatus('Failed to switch camera.');
                setTimeout(() => updateStatus(''), 2000);
            }
        };

        socket.on('existing-peers', peers => {
            if (peers.length > 0) {
                const peerSocketId = peers[0];
                peerConnection = createPeerConnection(peerSocketId);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }
        });

        socket.on('new-peer', async (peerSocketId) => {
            peerConnection = createPeerConnection(peerSocketId);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('signal', { to: peerSocketId, payload: peerConnection.localDescription });
            } catch (err) {
                console.error("Error creating and sending offer:", err);
            }
        });

        socket.on('signal', async ({ from, payload }) => {
            if (!peerConnection) {
                peerConnection = createPeerConnection(from);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            }

            try {
                if (payload.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(payload));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('signal', { to: from, payload: peerConnection.localDescription });
                } else if (payload.type === 'answer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(payload));
                } else if (payload.type === 'candidate') {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
                }
            } catch (err) {
                console.error(`Error handling signal from ${from}:`, err);
            }
        });
        
        socket.on('peer-left', peerSocketId => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            remoteVideo.srcObject = null;
            updateStatus('The other person has left the call.');
        });

        toggleAudioBtn.addEventListener('click', () => {
            if (!localStream) return;
            isAudioMuted = !isAudioMuted;
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !isAudioMuted;
            toggleAudioBtn.classList.toggle('off', isAudioMuted);
            toggleAudioBtn.innerHTML = isAudioMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
        });

        toggleVideoBtn.addEventListener('click', () => {
            if (!localStream) return;
            isVideoOff = !isVideoOff;
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !isVideoOff;
            toggleVideoBtn.classList.toggle('off', isVideoOff);
            toggleVideoBtn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
            localVideo.style.display = isVideoOff ? 'none' : 'block';
        });

        switchCameraBtn.addEventListener('click', replaceVideoTrack);
        
        leaveBtn.addEventListener('click', () => {
            socket.disconnect();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            window.history.back();
        });

        init();
    </script>
</body>
</html>
