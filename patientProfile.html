<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Profile Dashboard & Personal Health Records | 24x7 Health Services</title>
    <meta name="description" content="Secure patient profile dashboard. Manage your personal health records, appointments, prescriptions & medical history in one place. Easy-to-use patient portal for healthcare management.">
    <meta name="keywords" content="patient profile, patient dashboard, health records, personal medical records, appointment management, prescription tracker, patient portal, healthcare management, medical history, patient health portal, electronic health records">
    <meta name="author" content="24x7 Health Services">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta property="og:title" content="Patient Profile Dashboard & Personal Health Records | 24x7 Health Services">
    <meta property="og:description" content="Secure patient portal for managing health records, appointments, and medical information in one central location.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.24x7health.in/patientProfile.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Patient Profile Dashboard & Personal Health Records | 24x7 Health Services">
    <meta name="twitter:description" content="Manage your patient profile, health records & appointments through our secure patient portal.">
    <link rel="canonical" href="https://www.24x7health.in/patientProfile.html">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "MedicalBusiness",
      "name": "24x7 Health Services - Patient Portal",
      "description": "Secure patient profile and health records management system with appointment scheduling and prescription tracking",
      "url": "https://www.24x7health.in/patientProfile.html",
      "telephone": "+91-9908793602",
      "email": "support@24x7health.in",
      "serviceType": ["Patient Portal", "Health Records Management", "Appointment Scheduling", "Prescription Management"],
      "areaServed": "IN",
      "priceRange": "Free"
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .sidebar-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            color: #4b5563;
            transition: all 0.2s ease;
            border: none;
            background-color: transparent;
            text-align: left;
        }
        .sidebar-btn:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .sidebar-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .sidebar-btn i {
            width: 1.5rem;
            margin-right: 0.75rem;
            text-align: center;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .form-label {
            font-weight: 500;
            color: #374151;
        }
        .gemini-response h3 {
            font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #1e3a8a;
        }
        .gemini-response ul {
            list-style-type: disc; margin-left: 1.5rem; space-y: 0.25rem;
        }
        .gemini-response p {
            margin-bottom: 0.75rem;
        }
        .appointment-card {
            transition: all 0.2s ease;
            border-left: 4px solid #4f46e5;
        }
        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-confirmed {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .badge-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .badge-completed {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .badge-cancelled {
            background-color: #FEE2E2;
            color: #B91C1C;
        }
        .reschedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .reschedule-modal.active {
            display: flex;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.25rem;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-80 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col">
            <div class="h-16 flex items-center justify-center border-b border-gray-200">
                 <img class="h-8 w-auto" src="https://placehold.co/200x50/4f46e5/white?text=24x7health" alt="Logo">
            </div>
            <div class="flex flex-col items-center p-6 border-b border-gray-200">
                <img id="sidebar_photo_display" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile Photo" class="w-24 h-24 rounded-full border-4 border-indigo-100 object-cover">
                <h3 id="sidebar_full_name" class="text-lg font-semibold text-gray-800 mt-3"></h3>
                <p class="text-gray-500 text-sm" id="sidebar_unique_id"></p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button id="show-home-btn" class="sidebar-btn active"><i class="fas fa-home"></i>Home</button>
                <button id="show-doctor-appointments-btn" class="sidebar-btn"><i class="fas fa-user-doctor"></i>Doctor Appointments</button>
                <button id="show-diagnostic-appointments-btn" class="sidebar-btn"><i class="fas fa-microscope"></i>Diagnostic Appointments</button>
                <button id="show-history-btn" class="sidebar-btn"><i class="fas fa-history"></i>History</button>
                <button id="show-profile-btn" class="sidebar-btn"><i class="fas fa-user-circle"></i>Profile</button>
            </nav>
            <div class="p-4 border-t border-gray-200">
                 <button id="logout-button" class="sidebar-btn hover:bg-red-50 hover:text-red-600"><i class="fas fa-sign-out-alt"></i>Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div id="loading-state" class="text-center pt-20">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
                <p class="mt-2 text-lg text-gray-600">Loading Dashboard...</p>
            </div>

            <!-- Home Section -->
            <section id="home-view" class="content-section">
                <h1 style="font-size: 32px; font-weight: bold; color: #0056d2; margin-bottom: 15px;">Patient Profile & Health Dashboard</h1>
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Welcome <span id="welcome-name"></span> - Your Personal Health Portal</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Today's Appointments -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold text-lg mb-4 flex items-center">
                            <i class="fas fa-calendar-day text-indigo-600 mr-2"></i>Today's Appointments
                        </h3>
                        <div id="todays-appointments-list" class="space-y-3"></div>
                        <div id="no-todays-appointments" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-check-circle text-3xl mb-2 text-green-500"></i>
                            <p>No appointments for today.</p>
                        </div>
                    </div>
                    <!-- Upcoming Appointments -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold text-lg mb-4 flex items-center">
                            <i class="fas fa-calendar-alt text-indigo-600 mr-2"></i>Upcoming Appointments
                        </h3>
                        <div id="upcoming-appointments-list" class="space-y-3"></div>
                        <div id="no-upcoming-appointments" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-calendar-plus text-3xl mb-2 text-blue-500"></i>
                            <p>No upcoming appointments.</p>
                        </div>
                    </div>
                </div>
                 <!-- AI Health Insights -->
                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fas fa-robot text-indigo-600 mr-2"></i>✨ AI Health Insights
                    </h3>
                    <div class="text-center">
                        <p class="mb-4 text-gray-600">Get personalized wellness tips based on your health profile.</p>
                        <button id="generate-insights-btn" class="px-6 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>Generate My Health Summary
                        </button>
                    </div>
                    <div id="insights-result" class="mt-6 hidden">
                        <div id="insights-loading" class="text-center">
                            <i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i>
                            <p class="mt-2 text-gray-500">Generating insights...</p>
                        </div>
                        <div id="insights-content" class="gemini-response p-4 bg-indigo-50 rounded-lg border border-indigo-200 mt-4"></div>
                    </div>
                </div>
            </section>

            <!-- Doctor Appointments Section -->
            <section id="doctor-appointments-view" class="content-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-user-doctor text-indigo-600 mr-2"></i>Doctor Appointments & Medical Consultations
                    </h2>
                    <button id="refresh-doctor-appointments" class="px-4 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="all-doctor-appointments-list" class="space-y-4"></div>
                    <div id="no-doctor-appointments" class="text-center py-8 text-gray-500 hidden">
                        <i class="fas fa-user-doctor text-3xl mb-2 text-gray-400"></i>
                        <p>No doctor appointments found.</p>
                    </div>
                </div>
            </section>
            
            <!-- Diagnostic Appointments Section -->
            <section id="diagnostic-appointments-view" class="content-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-microscope text-indigo-600 mr-2"></i>Diagnostic Tests & Lab Appointments
                    </h2>
                    <button id="refresh-diagnostic-appointments" class="px-4 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <div id="all-diagnostic-appointments-list" class="space-y-4"></div>
                    <div id="no-diagnostic-appointments" class="text-center py-8 text-gray-500 hidden">
                        <i class="fas fa-microscope text-3xl mb-2 text-gray-400"></i>
                        <p>No diagnostic appointments found.</p>
                    </div>
                </div>
            </section>

            <!-- History Section -->
            <section id="history-view" class="content-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-history text-indigo-600 mr-2"></i>Appointment History & Medical Records
                    </h2>
                    <button id="refresh-history" class="px-4 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="history-list" class="space-y-4"></div>
                    <div id="no-history" class="text-center py-8 text-gray-500 hidden">
                        <i class="fas fa-history text-3xl mb-2 text-gray-400"></i>
                        <p>No past appointments found.</p>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile-view" class="content-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-user-circle text-indigo-600 mr-2"></i>My Patient Profile & Personal Health Information
                    </h2>
                    <button id="edit-profile-btn" class="px-6 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-edit mr-2"></i>Edit Profile
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><p class="text-sm text-gray-500">First Name</p><p id="view_first_name" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Last Name</p><p id="view_last_name" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Email</p><p id="view_email" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Mobile</p><p id="view_mobile" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Date of Birth</p><p id="view_dob" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Gender</p><p id="view_gender" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Blood Group</p><p id="view_blood_group" class="font-semibold text-lg"></p></div>
                        <div><p class="text-sm text-gray-500">Known Conditions</p><p id="view_disease" class="font-semibold text-lg"></p></div>
                        <div class="md:col-span-2"><p class="text-sm text-gray-500">Address</p><p id="view_address" class="font-semibold text-lg"></p></div>
                    </div>
                </div>
            </section>

            <!-- Edit Profile Section -->
            <section id="edit-profile-view" class="content-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-user-edit text-indigo-600 mr-2"></i>Edit Patient Profile & Health Information
                </h2>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="message-container" class="mb-6"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="first_name" class="form-label">First Name</label><input type="text" id="first_name" class="form-input"></div>
                        <div><label for="last_name" class="form-label">Last Name</label><input type="text" id="last_name" class="form-input"></div>
                        <div><label for="mobile" class="form-label">Mobile</label><input type="tel" id="mobile" class="form-input"></div>
                        <div><label for="dob" class="form-label">Date of Birth</label><input type="date" id="dob" class="form-input"></div>
                        <div><label for="gender" class="form-label">Gender</label><select id="gender" class="form-input"><option>Male</option><option>Female</option><option>Other</option></select></div>
                        <div><label for="blood_group" class="form-label">Blood Group</label><select id="blood_group" class="form-input"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option></select></div>
                        <div class="md:col-span-2"><label for="disease" class="form-label">Known Conditions/Diseases</label><input type="text" id="disease" class="form-input"></div>
                        <div class="md:col-span-2"><label for="address" class="form-label">Address</label><textarea id="address" class="form-input" rows="3"></textarea></div>
                        <div class="md:col-span-2"><label for="profile_photo_input" class="form-label">Update Profile Photo</label><input type="file" id="profile_photo_input" accept="image/*" class="form-input"></div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button id="cancel-edit-btn" class="px-6 py-2 rounded-md font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Cancel</button>
                        <button id="save-changes-btn" class="px-6 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">Save Changes</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Reschedule Modal -->
    <div id="reschedule-modal" class="reschedule-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Reschedule Appointment</h3>
                <button id="close-reschedule-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="reschedule-modal-body">
                <p class="mb-4">Select a new date for your appointment:</p>
                <div class="mb-4">
                    <label for="new-appointment-date" class="form-label">New Date</label>
                    <input type="date" id="new-appointment-date" class="form-input">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-reschedule" class="px-4 py-2 rounded-md font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Cancel</button>
                    <button id="confirm-reschedule" class="px-4 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">Reschedule</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global Variables ---
            let originalProfileData = {};
            let allAppointments = [];
            let allDiagnosticAppointments = [];
            let reviewedAppointmentIds = { doctor: [], diagnostic: [] }; // To track reviewed appointments
            let base64PhotoData = null;
            let currentReschedulePaymentId = null;

            // --- DOM Elements ---
            const loadingState = document.getElementById('loading-state');
            const sidebarBtns = document.querySelectorAll('.sidebar-btn');
            const contentSections = document.querySelectorAll('.content-section');
            const logoutButton = document.getElementById('logout-button');
            const photoInput = document.getElementById('profile_photo_input');
            const saveBtn = document.getElementById('save-changes-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const generateInsightsBtn = document.getElementById('generate-insights-btn');
            const insightsResult = document.getElementById('insights-result');
            const insightsLoading = document.getElementById('insights-loading');
            const insightsContent = document.getElementById('insights-content');
            const rescheduleModal = document.getElementById('reschedule-modal');
            const closeRescheduleModal = document.getElementById('close-reschedule-modal');
            const cancelReschedule = document.getElementById('cancel-reschedule');
            const confirmReschedule = document.getElementById('confirm-reschedule');
            const newAppointmentDate = document.getElementById('new-appointment-date');
            const refreshDoctorBtn = document.getElementById('refresh-doctor-appointments');
            const refreshDiagnosticBtn = document.getElementById('refresh-diagnostic-appointments');
            const refreshHistoryBtn = document.getElementById('refresh-history');
            
            // --- 1. Authentication & Initial Data Fetch ---
            const uniqueId = localStorage.getItem('uniqueId');
            if (!uniqueId) {
                window.location.href = 'login.html';
                return;
            }

            async function fetchAllData() {
                try {
                    loadingState.style.display = 'block';
                    
                    const profileResponse = await fetch(`https://www.24x7health.in/api/patient/profile/${uniqueId}`);
                    if (!profileResponse.ok) throw new Error('Could not fetch profile data.');
                    const profileData = await profileResponse.json();
                    
                    if (profileData.patient) {
                        originalProfileData = profileData.patient;
                        window.originalProfileData = originalProfileData; // Make it globally accessible for rating modal
                        
                        // Fetch reviewed appointment IDs
                        const reviewedResponse = await fetch(`https://www.24x7health.in/api/ratings/user/${originalProfileData.unique_id}/reviewed-ids`);
                        if(reviewedResponse.ok) {
                            reviewedAppointmentIds = await reviewedResponse.json();
                        }

                        populateAllViews(originalProfileData);

                        // Fetch doctor appointments
                        const appointmentsResponse = await fetch(`https://www.24x7health.in/api/appointments/patient/${originalProfileData.id}`);
                        const appointmentData = await appointmentsResponse.json();
                        allAppointments = appointmentData.appointments || [];
                        
                        // Fetch diagnostic appointments
                        await fetchDiagnosticAppointments();

                        populateAllAppointmentViews();
                        
                        loadingState.style.display = 'none';
                        switchView('home-view');
                    } else {
                        throw new Error('Patient data not found.');
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loadingState.innerHTML = `<p class="text-red-500">Failed to load dashboard. Please <a href="login.html" class="underline">log in</a> again.</p>`;
                }
            }

            async function fetchDiagnosticAppointments() {
                try {
                    const response = await fetch(`https://www.24x7health.in/api/newpayment/get`);
                    if (!response.ok) throw new Error('Could not fetch diagnostic appointments.');
                    const diagnosticData = await response.json();
                    
                    allDiagnosticAppointments = diagnosticData.filter(appt => 
                        appt.patient_email === originalProfileData.email || 
                        appt.patient_mobile === originalProfileData.mobile
                    );
                } catch (error) {
                    console.error('Error fetching diagnostic appointments:', error);
                    allDiagnosticAppointments = [];
                }
            }

        // -------------------------
        // Helpers: parse date+time and fetch reviewed IDs
        // -------------------------
        function parseAppointmentDateTime(dateStr, timeStr) {
            if (!dateStr) return null;
            const t = (timeStr || '').toString().trim();

            // parse time (supports `HH:MM`, `HH:MM AM/PM`, `1200`, `12:00 PM` etc.)
            let hours = 0, minutes = 0;
            const ampmMatch = t.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (ampmMatch) {
                hours = parseInt(ampmMatch[1], 10);
                minutes = parseInt(ampmMatch[2], 10);
                const ampm = ampmMatch[3].toUpperCase();
                if (ampm === 'PM' && hours !== 12) hours += 12;
                if (ampm === 'AM' && hours === 12) hours = 0;
            } else {
                const hmatch = t.match(/(\d{1,2}):(\d{2})/);
                if (hmatch) {
                hours = parseInt(hmatch[1], 10);
                minutes = parseInt(hmatch[2], 10);
                } else {
                    // fallback for strings like "1200" or "9"
                    const digits = t.replace(/\D/g, '');
                    if (digits.length >= 3) {
                        minutes = parseInt(digits.slice(-2), 10);
                        hours = parseInt(digits.slice(0, digits.length - 2), 10);
                    } else if (digits.length > 0) {
                        hours = parseInt(digits, 10);
                    }
                }
            }


            // parse date string (expecting yyyy-mm-dd or dd/mm/yyyy common formats)
            let year, monthIndex, day;
            if (dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts[0].length === 4) { // yyyy-mm-dd
                year = parseInt(parts[0], 10);
                monthIndex = parseInt(parts[1], 10) - 1;
                day = parseInt(parts[2], 10);
                } else { // maybe dd-mm-yyyy
                year = parseInt(parts[2], 10);
                monthIndex = parseInt(parts[1], 10) - 1;
                day = parseInt(parts[0], 10);
                }
            } else if (dateStr.includes('/')) {
                const parts = dateStr.split('/'); // dd/mm/yyyy
                year = parseInt(parts[2], 10);
                monthIndex = parseInt(parts[1], 10) - 1;
                day = parseInt(parts[0], 10);
            } else {
                const parsed = new Date(dateStr);       
                if (!isNaN(parsed)) {
                year = parsed.getFullYear(); monthIndex = parsed.getMonth(); day = parsed.getDate();
                } else {
                // fallback: today
                const now = new Date(); year = now.getFullYear(); monthIndex = now.getMonth(); day = now.getDate();
                }
            }

            return new Date(year, monthIndex, day, hours, minutes, 0, 0);
        }


        async function fetchReviewedIds() {
            try {
                if (!window.originalProfileData || !window.originalProfileData.unique_id) return;
                const resp = await fetch(`https://www.24x7health.in/api/ratings/user/${window.originalProfileData.unique_id}/reviewed-ids`);
                if (!resp.ok) return;
                const data = await resp.json();
                // server returns { success: true, doctor: [...], diagnostic: [...] }
                reviewedAppointmentIds.doctor = Array.isArray(data.doctor) ? data.doctor : (data.doctor || []);
                reviewedAppointmentIds.diagnostic = Array.isArray(data.diagnostic) ? data.diagnostic : (data.diagnostic || []);
            } catch (err) {
                console.error('Failed to fetch reviewed ids', err);
            }
        }
                
            // --- 2. Populate Views ---
            function populateAllViews(patient) {
                document.getElementById('sidebar_photo_display').src = patient.profile_photo || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                document.getElementById('sidebar_full_name').textContent = `${patient.first_name} ${patient.last_name}`;
                document.getElementById('sidebar_unique_id').textContent = `ID: ${patient.unique_id}`;
                document.getElementById('welcome-name').textContent = patient.first_name;
                
                const fields = {
                    'view_first_name': patient.first_name, 'view_last_name': patient.last_name,
                    'view_email': patient.email, 'view_mobile': patient.mobile,
                    'view_dob': patient.dob ? new Date(patient.dob).toLocaleDateString() : 'N/A',
                    'view_gender': patient.gender, 'view_blood_group': patient.blood_group,
                    'view_disease': patient.disease, 'view_address': patient.address,
                    'first_name': patient.first_name, 'last_name': patient.last_name,
                    'mobile': patient.mobile, 'gender': patient.gender,
                    'blood_group': patient.blood_group, 'disease': patient.disease, 'address': patient.address
                };
                for (const id in fields) {
                    const el = document.getElementById(id);
                    if (el) el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' ? el.value = fields[id] : el.textContent = fields[id];
                }
                document.getElementById('dob').value = patient.dob ? new Date(patient.dob).toISOString().split('T')[0] : '';
            }

            function populateAllAppointmentViews() {
                 const now = new Date();
                 const todayStart = new Date();
                 todayStart.setHours(0, 0, 0, 0);

                // Filter all appointments into past, today, and upcoming
                const pastAppointments = [];
                const todaysAppointments = [];
                const upcomingAppointments = [];

                [...allAppointments, ...allDiagnosticAppointments].forEach(appt => {
                    const isDiagnostic = !!appt.payment_id;
                    const apptDateTime = isDiagnostic 
                        ? new Date(appt.test_date)
                        : new Date(`${appt.appointment_date} ${appt.appointment_time || '00:00'}`);
                    
                    const apptDateOnly = new Date(apptDateTime);
                    apptDateOnly.setHours(0,0,0,0);

                    if (apptDateTime < now) {
                        pastAppointments.push(appt);
                    } else if (apptDateOnly.getTime() === todayStart.getTime()) {
                        todaysAppointments.push(appt);
                    } else {
                        upcomingAppointments.push(appt);
                    }
                });

                renderAppointments(todaysAppointments, 'todays-appointments-list', 'no-todays-appointments');
                renderAppointments(upcomingAppointments, 'upcoming-appointments-list', 'no-upcoming-appointments');
                renderAppointments(pastAppointments, 'history-list', 'no-history');
                
                renderDoctorAppointments(allAppointments, 'all-doctor-appointments-list', 'no-doctor-appointments');
                renderDiagnosticAppointments(allDiagnosticAppointments, 'all-diagnostic-appointments-list', 'no-diagnostic-appointments');
            }
            
            function getStatusClass(status) {
                switch (status?.toLowerCase()) {
                    case 'completed': return 'completed';
                    case 'confirmed': return 'confirmed';
                    case 'scheduled': return 'confirmed';
                    case 'pending': return 'pending';
                    case 'cancelled': return 'cancelled';
                    default: return 'pending';
                }
            }


            // Generic renderer for home screen cards
            function renderAppointments(appointmentArray, listId, emptyMsgId) {
                const listEl = document.getElementById(listId);
                const emptyMsgEl = document.getElementById(emptyMsgId);
                listEl.innerHTML = '';

                if (appointmentArray && appointmentArray.length > 0) {
                    emptyMsgEl.classList.add('hidden');
                    appointmentArray.sort((a,b) => new Date(a.appointment_date || a.test_date) - new Date(b.appointment_date || b.test_date));

                    appointmentArray.forEach(appt => {
                        const isDiagnostic = !!appt.payment_id;
                        const apptDate = new Date(isDiagnostic ? appt.test_date : appt.appointment_date)
                            .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        
                        const apptElement = document.createElement('div');
                        apptElement.className = 'appointment-card p-4 border rounded-lg bg-white';
                        
                        let content = isDiagnostic ? `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${appt.test_name}</p>
                                    <p class="text-sm text-gray-600">${appt.center_name}</p>
                                    <p class="text-xs text-gray-500 mt-1">On: ${apptDate}</p>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-${getStatusClass(appt.status)}">${appt.status || 'Scheduled'}</span>
                                </div>
                            </div>
                        ` : `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">Dr. ${appt.doctor_name || 'N/A'}</p>
                                    <p class="text-sm text-gray-600">${appt.doctor_specialization || 'Consultation'}</p>
                                    <p class="text-xs text-gray-500 mt-1">On: ${apptDate} at ${appt.appointment_time}</p>
                                </div>
                                <div class="text-right">
                                     <span class="badge badge-${getStatusClass(appt.status)}">${appt.status || 'Pending'}</span>
                                </div>
                            </div>
                        `;
                        
                        apptElement.innerHTML = content;
                        listEl.appendChild(apptElement);
                    });
                } else {
                    emptyMsgEl.classList.remove('hidden');
                }
            }

             // Specific renderer for Doctor Appointments view with time-based logic
            function renderDoctorAppointments(appointmentArray, listId, emptyMsgId) {
            const listEl = document.getElementById(listId);
            const emptyMsgEl = document.getElementById(emptyMsgId);
            listEl.innerHTML = '';


            if (appointmentArray && appointmentArray.length > 0) {
            emptyMsgEl.classList.add('hidden');
            appointmentArray.sort((a,b) => {
            const da = parseAppointmentDateTime(a.appointment_date, a.appointment_time) || new Date(0);
            const db = parseAppointmentDateTime(b.appointment_date, b.appointment_time) || new Date(0);
            return da - db;
            });


            appointmentArray.forEach(appt => {
            const apptDateObj = parseAppointmentDateTime(appt.appointment_date, appt.appointment_time);
            const apptDate = apptDateObj ? apptDateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : (appt.appointment_date || 'N/A');


            const apptElement = document.createElement('div');
            apptElement.className = 'appointment-card p-4 border rounded-lg bg-white';


            let apptHTML = `
            <div class="flex justify-between items-start">
            <div class="flex-1">
            <p class="font-semibold text-gray-800">Dr. ${appt.doctor_name || 'N/A'}</p>
            <p class="text-sm text-gray-600">${appt.doctor_specialization || 'Consultation'}</p>
            <p class="text-xs text-gray-500 mt-1">On: ${apptDate} at ${appt.appointment_time || 'N/A'}</p>
            </div>
            <div class="text-right">
            <span class="badge badge-${getStatusClass(appt.status)}">${appt.status || 'Pending'}</span>
            </div>
            </div>
            <div class="mt-4 flex justify-end space-x-2"></div>`;


            apptElement.innerHTML = apptHTML;


            const now = new Date();
            const hasBeenReviewed = Array.isArray(reviewedAppointmentIds.doctor) && reviewedAppointmentIds.doctor.includes(appt.id);
            const buttonContainer = apptElement.querySelector('.flex.justify-end');


            // If appointment time is available and <= now -> past appointment
            if (apptDateObj && apptDateObj.getTime() <= now.getTime()) {
            if (!hasBeenReviewed) {
            const rateBtn = document.createElement('button');
            rateBtn.innerText = 'Review';
            rateBtn.className = 'rate-btn px-4 py-1 rounded-md text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200 transition-colors';
            rateBtn.setAttribute('data-type', 'doctor');
            rateBtn.setAttribute('data-appt', JSON.stringify(appt));
            buttonContainer.appendChild(rateBtn);
            } else {
            const reviewedText = document.createElement('p');
            reviewedText.innerText = 'Reviewed';
            reviewedText.className = 'text-sm text-gray-500 font-medium';
            buttonContainer.appendChild(reviewedText);
            }
            } else {
                // const rescheduleBtn = document.createElement('button');
                // rescheduleBtn.innerText = 'Reschedule';
                // rescheduleBtn.className = 'reschedule-btn px-4 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors';
                // rescheduleBtn.onclick = () => alert('Doctor appointment rescheduling coming soon!');
                // buttonContainer.appendChild(rescheduleBtn);
            }


            listEl.appendChild(apptElement);
            });
            } else {
            emptyMsgEl.classList.remove('hidden');
            }
            }

            // Specific renderer for Diagnostic Appointments view with time-based logic
            function renderDiagnosticAppointments(appointmentArray, listId, emptyMsgId) {
                const listEl = document.getElementById(listId);
                const emptyMsgEl = document.getElementById(emptyMsgId);
                listEl.innerHTML = '';

                if (appointmentArray && appointmentArray.length > 0) {
                    emptyMsgEl.classList.add('hidden');
                    appointmentArray.sort((a,b) => new Date(a.test_date) - new Date(b.test_date));

                    appointmentArray.forEach(appt => {
                        const apptDateStr = new Date(appt.test_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        const apptElement = document.createElement('div');
                        apptElement.className = 'appointment-card p-4 border rounded-lg bg-white';
                        
                        let apptHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800 text-lg">${appt.test_name}</p>
                                    <p class="text-sm text-gray-600">${appt.center_name}</p>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-${getStatusClass(appt.status)}">${appt.status || 'Scheduled'}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                                <div><span class="font-medium">Date:</span> ${apptDateStr}</div>
                                <div><span class="font-medium">Collection Type:</span> ${appt.collection_type}</div>
                                <div><span class="font-medium">Amount:</span> ₹${appt.amount}</div>
                                <div><span class="font-medium">Payment Method:</span> ${appt.payment_method}</div>
                            </div>
                            <div class="mt-3 text-xs text-gray-500">
                                <p>Payment ID: ${appt.payment_id}</p>
                            </div>
                            <div class="mt-4 flex justify-end space-x-2">`;
                        
                        const now = new Date();
                        const apptDate = new Date(appt.test_date);
                        apptDate.setHours(23, 59, 59, 999); // Consider the appointment "past" only after the day has ended
                        const hasBeenReviewed = reviewedAppointmentIds.diagnostic.includes(appt.payment_id);

                        if (apptDate < now) {
                            if (!hasBeenReviewed) {
                                apptHTML += `<button class="rate-btn px-4 py-1 rounded-md text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200 transition-colors" data-type="diagnostic" data-appt='${JSON.stringify(appt)}'>Review</button>`;
                            } else {
                                 apptHTML += `<p class="text-sm text-gray-500 font-medium">Reviewed</p>`;
                            }
                        } else {
                            apptHTML += `<button class="reschedule-btn px-4 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-payment-id="${appt.payment_id}">Reschedule</button>`;
                        }

                        apptHTML += `</div>`;
                        apptElement.innerHTML = apptHTML;
                        
                        listEl.appendChild(apptElement);
                    });

                    document.querySelectorAll('.reschedule-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const paymentId = this.getAttribute('data-payment-id');
                            openRescheduleModal(paymentId);
                        });
                    });
                } else {
                    emptyMsgEl.classList.remove('hidden');
                }
            }


            function openRescheduleModal(paymentId) {
                currentReschedulePaymentId = paymentId;
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const maxDate = new Date();
                maxDate.setDate(tomorrow.getDate() + 30);
                
                newAppointmentDate.min = tomorrow.toISOString().split('T')[0];
                newAppointmentDate.max = maxDate.toISOString().split('T')[0];
                newAppointmentDate.value = '';
                
                rescheduleModal.classList.add('active');
            }

            function closeRescheduleModalFunc() {
                rescheduleModal.classList.remove('active');
                currentReschedulePaymentId = null;
            }

            async function rescheduleAppointment() {
                const newDate = newAppointmentDate.value;
                if (!newDate) {
                    alert('Please select a new date');
                    return;
                }

                try {
                    const response = await fetch(`https://www.24x7health.in/api/newpayment/reschedule/${currentReschedulePaymentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newDate })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Appointment rescheduled successfully!');
                        closeRescheduleModalFunc();
                        await fetchDiagnosticAppointments();
                        populateAllAppointmentViews();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Reschedule error:', error);
                    alert('Failed to reschedule appointment. Please try again.');
                }
            }

            // --- 3. View Switching Logic ---
            function switchView(viewId) {
                contentSections.forEach(section => section.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                sidebarBtns.forEach(btn => btn.classList.remove('active'));
                
                let activeBtnId;
                if (viewId === 'home-view') activeBtnId = 'show-home-btn';
                else if (viewId === 'doctor-appointments-view') activeBtnId = 'show-doctor-appointments-btn';
                else if (viewId === 'diagnostic-appointments-view') activeBtnId = 'show-diagnostic-appointments-btn';
                else if (viewId === 'history-view') activeBtnId = 'show-history-btn';
                else if (viewId === 'profile-view' || viewId === 'edit-profile-view') activeBtnId = 'show-profile-btn';
                
                if (activeBtnId) document.getElementById(activeBtnId).classList.add('active');
            }

            // --- 4. Event Listeners ---
            document.getElementById('show-home-btn').addEventListener('click', () => switchView('home-view'));
            document.getElementById('show-doctor-appointments-btn').addEventListener('click', () => switchView('doctor-appointments-view'));
            document.getElementById('show-diagnostic-appointments-btn').addEventListener('click', () => switchView('diagnostic-appointments-view'));
            document.getElementById('show-history-btn').addEventListener('click', () => switchView('history-view'));
            document.getElementById('show-profile-btn').addEventListener('click', () => switchView('profile-view'));
            editProfileBtn.addEventListener('click', () => switchView('edit-profile-view'));
            cancelBtn.addEventListener('click', () => {
                 populateAllViews(originalProfileData); 
                 switchView('profile-view');
            });
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('uniqueId');
                window.location.href = 'login.html';
            });
            refreshDoctorBtn.addEventListener('click', async () => {
                const response = await fetch(`https://www.24x7health.in/api/appointments/patient/${originalProfileData.id}`);
                const appointmentData = await response.json();
                allAppointments = appointmentData.appointments || [];
                populateAllAppointmentViews();
            });
            refreshDiagnosticBtn.addEventListener('click', async () => {
                await fetchDiagnosticAppointments();
                populateAllAppointmentViews();
            });
            refreshHistoryBtn.addEventListener('click', async () => {
                 await fetchAllData();
                 switchView('history-view');
            });
            photoInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        base64PhotoData = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            saveBtn.addEventListener('click', async function() {
                const updatedData = {
                    first_name: document.getElementById('first_name').value,
                    last_name: document.getElementById('last_name').value,
                    mobile: document.getElementById('mobile').value,
                    dob: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    blood_group: document.getElementById('blood_group').value,
                    disease: document.getElementById('disease').value,
                    address: document.getElementById('address').value,
                };

                if (base64PhotoData) {
                    updatedData.profile_photo = base64PhotoData;
                }
                
                try {
                    const response = await fetch(`https://www.24x7health.in/api/patient/update/${originalProfileData.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedData)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        originalProfileData = result.patient;
                        base64PhotoData = null;
                        populateAllViews(originalProfileData);
                        switchView('profile-view');
                        showMessage('Profile updated successfully!', 'success');
                    } else {
                        showMessage('Error updating profile: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Update error:', error);
                    showMessage('Failed to update profile. Please try again.', 'error');
                }
            });
            generateInsightsBtn.addEventListener('click', async function() {
                insightsResult.classList.remove('hidden');
                insightsLoading.classList.remove('hidden');
                insightsContent.classList.add('hidden');
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const healthSummary = `
                        <h3>Health Summary for ${originalProfileData.first_name}</h3>
                        <p>Based on your profile information, here are some personalized health insights:</p>
                        <ul>
                            <li>Maintain regular check-ups given your ${originalProfileData.blood_group} blood type</li>
                            <li>Consider monitoring for conditions common with your known health history</li>
                            <li>Stay hydrated and maintain a balanced diet appropriate for your age group</li>
                            <li>Regular moderate exercise is recommended for overall wellness</li>
                        </ul>
                        <p>Remember to consult with your healthcare provider before making any significant changes to your lifestyle.</p>
                    `;
                    insightsContent.innerHTML = healthSummary;
                    insightsLoading.classList.add('hidden');
                    insightsContent.classList.remove('hidden');
                } catch (error) {
                    insightsContent.innerHTML = '<p class="text-red-500">Failed to generate insights. Please try again later.</p>';
                    insightsLoading.classList.add('hidden');
                    insightsContent.classList.remove('hidden');
                }
            });
            closeRescheduleModal.addEventListener('click', closeRescheduleModalFunc);
            cancelReschedule.addEventListener('click', closeRescheduleModalFunc);
            confirmReschedule.addEventListener('click', rescheduleAppointment);
            
            function showMessage(message, type) {
                const messageContainer = document.getElementById('message-container');
                messageContainer.innerHTML = `<div class="p-4 rounded-md ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${message}</div>`;
                setTimeout(() => { messageContainer.innerHTML = ''; }, 5000);
            }
            
            fetchAllData();
        });
    </script>

    <!-- Rating Modal -->
    <div id="rating-modal" class="reschedule-modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Rate Your Experience</h3>
            <button id="close-rating-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
            </div>
            <div>
            <p id="rating-modal-subtitle" class="mb-3 text-sm text-gray-600">How was your appointment?</p>
            
            <div id="rating-stars" class="flex justify-center space-x-2 mb-4 text-2xl text-gray-300">
                <i class="far fa-star cursor-pointer" data-value="1"></i>
                <i class="far fa-star cursor-pointer" data-value="2"></i>
                <i class="far fa-star cursor-pointer" data-value="3"></i>
                <i class="far fa-star cursor-pointer" data-value="4"></i>
                <i class="far fa-star cursor-pointer" data-value="5"></i>
            </div>

            <textarea id="rating-review" placeholder="Share more about your experience..." 
                class="form-input mb-4" rows="3"></textarea>

            <div class="flex justify-end space-x-3">
                <button id="cancel-rating" 
                class="px-4 py-2 rounded-md font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">
                Cancel
                </button>
                <button id="submit-rating" 
                class="px-4 py-2 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700">
                Submit Review
                </button>
            </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ratingModal = document.getElementById('rating-modal');
        const closeRatingModal = document.getElementById('close-rating-modal');
        const cancelRating = document.getElementById('cancel-rating');
        const submitRating = document.getElementById('submit-rating');
        const starsContainer = document.getElementById('rating-stars');
        const reviewInput = document.getElementById('rating-review');
        const ratingSubtitle = document.getElementById('rating-modal-subtitle');

        let currentRating = 0;
        let currentApptData = null;
        let currentType = null;

        function renderStars(rating) {
            const stars = starsContainer.querySelectorAll('i');
            stars.forEach(star => {
                if (parseInt(star.dataset.value) <= rating) {
                    star.classList.remove('far', 'text-gray-300');
                    star.classList.add('fas', 'text-yellow-400');
                } else {
                    star.classList.remove('fas', 'text-yellow-400');
                    star.classList.add('far', 'text-gray-300');
                }
            });
        }
        
        starsContainer.addEventListener('click', (e) => {
            if (e.target.matches('i')) {
                currentRating = parseInt(e.target.dataset.value);
                renderStars(currentRating);
            }
        });

        document.body.addEventListener('click', function(e) {
            if (e.target.closest('.rate-btn')) {
                const btn = e.target.closest('.rate-btn');
                currentApptData = JSON.parse(btn.getAttribute('data-appt'));
                currentType = btn.getAttribute('data-type');
                
                if (currentType === 'doctor') {
                    ratingSubtitle.textContent = `How was your appointment with Dr. ${currentApptData.doctor_name}?`;
                } else {
                    ratingSubtitle.textContent = `How was your experience with ${currentApptData.test_name} at ${currentApptData.center_name}?`;
                }

                currentRating = 0;
                renderStars(0);
                reviewInput.value = '';
                ratingModal.classList.add('active');
            }
        });

        function closeModal() {
            ratingModal.classList.remove('active');
            currentApptData = null;
            currentType = null;
        }

        closeRatingModal.addEventListener('click', closeModal);
        cancelRating.addEventListener('click', closeModal);

        submitRating.addEventListener('click', async () => {
            if (!currentRating) {
                alert('Please select a star rating!');
                return;
            }

            if (!window.originalProfileData || !window.originalProfileData.unique_id) {
                alert('Could not identify patient. Please refresh and try again.');
                return;
            }

            const payload = {
                appointmentId: currentType === 'doctor' ? currentApptData.id : currentApptData.payment_id,
                userId: window.originalProfileData.unique_id,
                userName: `${window.originalProfileData.first_name} ${window.originalProfileData.last_name}`,
                userEmail: window.originalProfileData.email,
                rating: currentRating,
                review: reviewInput.value
            };

            if (currentType === 'doctor') {
                Object.assign(payload, {
                    doctorUid: currentApptData.doctor_uid,
                    doctorName: currentApptData.doctor_name,
                    doctorEmail: currentApptData.doctor_email,
                    specialization: currentApptData.doctor_specialization
                });
            } else {
                Object.assign(payload, {
                    centerId: currentApptData.center_id,
                    centerName: currentApptData.center_name,
                    testId: currentApptData.test_id,
                    testName: currentApptData.test_name
                });
            }

            try {
                const res = await fetch(`https://www.24x7health.in/api/ratings/${currentType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const errorResult = await res.json();
                    throw new Error(errorResult.error || 'Server error');
                }

                const result = await res.json();
                if (result.success) {
                    alert('Review submitted successfully! Thank you for your feedback.');
                    closeModal();
                    // Manually refresh data to show "Reviewed" text instead of button
                    document.getElementById('refresh-doctor-appointments').click();
                    document.getElementById('refresh-diagnostic-appointments').click();

                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                console.error('Failed to submit review:', err);
                alert('Failed to submit review. Please check your connection and try again.');
            }
        });
    });
    </script>
    
</body>
</html>

